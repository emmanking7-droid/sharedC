<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shared Calendar — Rooms, Presence & Multi‑User Availability</title>
  <meta name="description" content="A single-file calendar with rooms, presence, and per-user availability. Optionally live via Firebase (paste your config)." />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://www.gstatic.com; connect-src 'self' https://firestore.googleapis.com; object-src 'none'; base-uri 'none'">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0d12; --panel:#0f131a; --panel-2:#11141b; --text:#e9edf1; --muted:#a7b0bb; --brand:#6aa7ff; --brand2:#7ef0d3; --radius:16px;
      --ring:0 0 0 3px rgba(106,167,255,.35); --shadow:0 10px 30px rgba(0,0,0,.35); --shadow-sm:0 4px 14px rgba(0,0,0,.25);
      --grid: clamp(14px, 2.4vw, 22px); --maxw:1200px; --cell-bg:#0d121c; --cell-border:#293043; --cell-hover:#162034;
      --avail:#2f8f5b; --danger:#ff6565;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text)}
    a{color:var(--text); text-decoration:none}
    .container{max-width:var(--maxw); margin-inline:auto; padding:0 var(--grid)}
    header{position:sticky; top:0; z-index:20; backdrop-filter:blur(10px); background:linear-gradient(180deg, rgba(11,13,18,.78), rgba(11,13,18,.45)); border-bottom:1px solid rgba(255,255,255,.06)}
    .nav{display:flex; align-items:center; justify-content:space-between; gap:10px; padding-block:10px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800}
    .logo-mark{height:28px; width:28px; border-radius:8px; background:conic-gradient(from 220deg, var(--brand), var(--brand2)); box-shadow:0 0 30px rgba(106,167,255,.35)}
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:9999px; border:1px solid #2a2f39; background:#0f131a; color:var(--text); font-weight:600; cursor:pointer}
    .btn.small{padding:6px 10px; font-size:12px}
    .btn.icon{padding:6px 10px}
    .btn.primary{background:linear-gradient(135deg, var(--brand), var(--brand2)); color:#0b0d12; border-color:transparent}
    .btn:focus{outline:none; box-shadow:var(--ring)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .badge{padding:6px 10px; border-radius:999px; background:#141927; border:1px solid #2a2f39; color:var(--muted); font-weight:600}

    .pill-input{display:flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #2a2f39; border-radius:999px; background:#0f131a}
    .pill-input input{background:transparent; border:none; color:var(--text); outline:none; min-width:120px}
    .pill-input .label{color:var(--muted); font-size:12px}

    /* 2-column layout: calendar + sidebar */
    .main-grid{display:grid; grid-template-columns: 1fr 320px; gap:16px; align-items:start;}
    @media (max-width: 980px){ .main-grid{ grid-template-columns: 1fr; } }

    .calendar{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); box-shadow:var(--shadow-sm); overflow:hidden}
    .cal-head{display:flex; flex-direction:column; gap:8px; padding:12px}
    .cal-nav{display:flex; align-items:center; justify-content:center; gap:8px}
    .cal-nav #monthLabel{min-width:220px; text-align:center; font-weight:800}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); border-top:1px solid rgba(255,255,255,.08)}
    .dow{padding:10px; text-align:center; color:var(--muted); font-weight:600; border-right:1px solid rgba(255,255,255,.06); background:var(--panel-2)}
    .dow:last-child{border-right:0}
    .cell{min-height:110px; border-top:1px solid var(--cell-border); border-right:1px solid var(--cell-border); padding:8px; position:relative; background:var(--cell-bg); transition:background .12s ease; cursor:pointer}
    .cell:hover{background:var(--cell-hover)}
    .cell:last-child{border-right:0}
    .daynum{font-size:12px; color:var(--muted)}
    .today .daynum{color:#fff; font-weight:800}
    .other-month{opacity:.55}
    .event{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px; padding:6px 8px; border-radius:10px; background:#1a2030; border:1px solid rgba(255,255,255,.12); font-size:12px; line-height:1.3; cursor:pointer}
    .event small{color:var(--muted)}
    .event .label{display:flex; flex-direction:column}
    .event .actions{display:flex; gap:6px}
    .event.cancelled{opacity:.6; text-decoration:line-through}
    .chip{font-size:11px; padding:2px 6px; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:#111728}
    .event .mini-btn{border:none; background:#0f131a; border:1px solid #2a2f39; border-radius:8px; padding:2px 6px; cursor:pointer; color:var(--text)}
    .event .mini-btn:focus{outline:none; box-shadow:var(--ring)}

    /* Availability dots in each cell (one per user) */
    .avail-dots{position:absolute; top:6px; right:6px; display:flex; gap:4px; flex-wrap:wrap; width:80px; justify-content:flex-end}
    .dot-user{width:10px; height:10px; border-radius:50%; box-shadow:0 0 6px rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.25)}

    dialog form .row{display:flex; gap:10px; align-items:center; margin-bottom:10px}
    input, textarea{width:100%; background:#0f131a; border:1px solid #2a2f39; color:var(--text); padding:10px; border-radius:10px}
    label{color:var(--muted); font-size:13px}
    #conflictMsg{color:#ffb4b4}

    /* Presence popover (kept) */
    .popover{position:relative}
    .popover-panel{position:absolute; right:0; top:calc(100% + 8px); min-width:260px; background:#0f131a; border:1px solid #2a2f39; border-radius:14px; box-shadow:var(--shadow); padding:10px; display:none}
    .popover.open .popover-panel{display:block}
    .roster{display:flex; flex-direction:column; gap:6px; max-height:260px; overflow:auto}
    .roster .row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; background:#111727; border:1px solid rgba(255,255,255,.06); border-radius:10px}
    .dot{width:8px; height:8px; border-radius:999px; background:#66f28f; box-shadow:0 0 8px rgba(102,242,143,.7)}
    .muted{color:var(--muted)}

    /* Rooms popover */
    .rooms-popover{position:relative}
    .rooms-panel{position:absolute; right:0; top:calc(100% + 8px); min-width:280px; background:#0f131a; border:1px solid #2a2f39; border-radius:14px; box-shadow:var(--shadow); padding:10px; display:none}
    .rooms-popover.open .rooms-panel{display:block}
    .rooms-list{display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto}
    .rooms-list .room-item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-radius:10px; background:#111727; border:1px solid rgba(255,255,255,.06); cursor:pointer}
    .rooms-list .room-name{font-weight:700}
    .rooms-actions{display:flex; gap:6px}
    .rooms-panel .row{display:flex; gap:8px; margin-top:8px}

    /* Sidebar cards */
    aside#side{position:sticky; top:86px;}
    .side-card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow:var(--shadow-sm); padding:12px; margin-bottom:16px}
    .side-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#111727; border:1px solid rgba(255,255,255,.08); font-size:12px}

    /* Users list */
    .user-list{display:flex; flex-direction:column; gap:8px}
    .user-row{display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; background:#0f131a; border:1px solid #2a2f39}
    .swatch{width:16px; height:16px; border-radius:50%; box-shadow:inset 0 0 0 2px rgba(255,255,255,.15)}
    .user-row .actions{margin-left:auto; display:flex; gap:6px}
    .tiny{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <a class="logo" href="#" title="Shared Calendar">
        <span class="logo-mark" aria-hidden="true"></span>
        <span>Shared Calendar</span>
      </a>
      <div class="controls" style="flex:1; justify-content:flex-end">
        <span id="liveBadge" class="badge">Local only</span>

        <div class="pill-input" title="Your display name">
          <span class="label">You</span>
          <input id="displayName" placeholder="e.g., Alex" />
        </div>
        <div class="pill-input" title="Room name (everyone joins the same name)">
          <span class="label">Room</span>
          <input id="roomInput" placeholder="e.g., movie-night" />
        </div>
        <button class="btn" id="btnJoin">Join</button>

        <div class="rooms-popover" id="roomsPopover">
          <button class="btn" id="btnRooms">Rooms ▾</button>
          <div class="rooms-panel">
            <div class="muted" style="margin-bottom:6px">Switch or create a room</div>
            <div class="rooms-list" id="roomsList"></div>
            <div class="row">
              <input id="newRoomInput" placeholder="new-room-name" />
              <button class="btn" id="btnCreateRoom" style="padding:8px 12px">Create & Join</button>
            </div>
          </div>
        </div>

        <div class="popover" id="presencePopover">
          <button class="btn" id="btnPresence"><span id="presenceCount">0</span> online ▾</button>
          <div class="popover-panel">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px">
              <div class="muted" id="roomLabel">Room: —</div>
              <button class="btn" id="btnLeave" style="padding:6px 10px">Leave</button>
            </div>
            <div class="roster" id="roster"></div>
          </div>
        </div>

        <button class="btn primary" id="btnAdd">＋ Add activity</button>
        <button class="btn" id="btnToggleAvail">Toggle Availability</button>
      </div>
    </div>
  </header>

  <main class="container main-grid">
    <section class="calendar">
      <div class="cal-head">
        <div class="cal-nav">
          <button class="btn icon" id="btnPrev">◀</button>
          <div id="monthLabel"></div>
          <button class="btn icon" id="btnNext">▶</button>
        </div>
        <div class="sub" style="text-align:center">Choose or <b>create a room</b>, click <b>Join</b>. Use the sidebar to manage <b>people</b>; select who you're acting as, then click a date to toggle their availability. Colored dots in each day show who's available.</div>
      </div>
      <div class="cal-grid" id="dow"></div>
      <div class="cal-grid" id="grid"></div>
    </section>

    <aside id="side">
      <div class="side-card">
        <div class="side-head">
          <strong>People in room</strong>
          <span class="pill"><span class="dot"></span> <span id="sideCount">0</span></span>
        </div>
        <div id="sidePresence" class="user-list"></div>
        <div id="sideHint" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="side-card">
        <div class="side-head"><strong>Friends & availability</strong> <span class="tiny">Acting as: <b id="actingAs">—</b></span></div>
        <div class="user-list" id="usersList"></div>
        <div class="row" style="margin-top:10px; display:flex; gap:8px">
          <input id="newUserName" placeholder="Add name (e.g., Sam)" />
          <button class="btn small" id="btnAddUser">Add</button>
        </div>
      </div>
    </aside>
  </main>

  <dialog id="eventDialog">
    <form method="dialog" id="eventForm">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 16px 0">
        <h3 style="margin:0">Activity</h3>
        <button class="btn" value="cancel" type="submit" formmethod="dialog">✕</button>
      </div>
      <div style="padding:16px; display:grid; gap:10px">
        <input type="hidden" id="evtId" />
        <div class="row">
          <label style="min-width:88px">Title</label>
          <input id="evtTitle" type="text" placeholder="Movie night" />
        </div>
        <div class="row">
          <label style="min-width:88px">Date</label>
          <input id="evtDate" type="date" />
        </div>
        <div class="row">
          <label style="min-width:88px">From</label>
          <input id="evtStart" type="time" value="18:00" />
          <label>To</label>
          <input id="evtEnd" type="time" value="20:00" />
        </div>
        <div class="row">
          <label style="min-width:88px">People</label>
          <input id="evtPeople" type="text" placeholder="anna, omar, li" />
        </div>
        <div class="row">
          <label style="min-width:88px">Notes</label>
          <textarea id="evtNotes" rows="2" placeholder="Bring snacks"></textarea>
        </div>
        <div class="row">
          <label style="min-width:88px">Status</label>
          <span class="chip" id="evtStatusChip">Planned</span>
        </div>
        <div class="row">
          <button class="btn primary" id="btnSave" value="save" type="submit">Save</button>
          <button class="btn" id="btnDelete" type="button">Delete</button>
        </div>
        <div class="muted" id="conflictMsg"></div>
      </div>
    </form>
  </dialog>

  <script type="module">
    const __SC_KEY__='__SC_SINGLETON__';
    try{ if(window[__SC_KEY__]?.teardown) window[__SC_KEY__].teardown(); }catch{}
    window[__SC_KEY__] = { teardown:null };

    (function(){
      'use strict';
      const SINGLETON = window[__SC_KEY__];

   const firebaseConfig = {
  apiKey: "AIzaSyAKdrW--5amKIO2IZaBrhiZYnsw3xByFP4",
  authDomain: "calend-2aabe.firebaseapp.com",
  projectId: "calend-2aabe",
  storageBucket: "calend-2aabe.firebasestorage.app",
  messagingSenderId: "70040581273",
  appId: "1:70040581273:web:c6852a7f467be95a457408",
  measurementId: "G-QLT6G2B5WQ"
};

      const CLIENT_ID = `c_${Math.random().toString(36).slice(2)}_${Date.now().toString(36)}`;
      const $ = (s,r=document)=>r.querySelector(s);
      const pad=(n)=>String(n).padStart(2,'0');
      const toKey=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

      const gridEl=$('#grid'), dowEl=$('#dow'), monthLabel=$('#monthLabel');
      const liveBadge=$('#liveBadge');
      const presenceCountEl=$('#presenceCount');
      const sideCount=$('#sideCount');
      const sidePresence=$('#sidePresence');
      const sideHint=$('#sideHint');
      const actingAsEl=$('#actingAs');

      const rosterEl=$('#roster'); const presencePopover=$('#presencePopover'); const btnPresence=$('#btnPresence'); const btnLeave=$('#btnLeave'); const roomLabel=$('#roomLabel');

      ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{const div=document.createElement('div');div.className='dow';div.textContent=d;dowEl.appendChild(div);});

      const storageKeyFor=(room)=>`shared-calendar-${room||'local'}-v3`;
      const ROOMS_KEY='shared-calendar-rooms-v1';

      let state={
        room:'',
        userName:localStorage.getItem('displayName')||'',
        today:new Date(),
        cursor:new Date(new Date().getFullYear(), new Date().getMonth(),1),
        events:[],
        users:[],
        currentUserId:'',
        availability:{},
        online:[]
      };
      let rooms=loadRooms();

      let presenceInterval=null;

      const nameInput=$('#displayName'); const roomInput=$('#roomInput'); const btnJoin=$('#btnJoin'); const roomsPopover=$('#roomsPopover'); const btnRooms=$('#btnRooms'); const roomsList=$('#roomsList'); const newRoomInput=$('#newRoomInput'); const btnCreateRoom=$('#btnCreateRoom');
      const usersList=$('#usersList'); const newUserName=$('#newUserName'); const btnAddUser=$('#btnAddUser');
      nameInput.value=state.userName;

      const PALETTE=['#7ef0d3','#6aa7ff','#ffb86b','#f78fb3','#ffd166','#9aedfe','#c792ea','#7bd88f','#ecc48d','#ff8ba7'];

      function genId(prefix='e'){ return `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`; }

      let markingAvailability=false;
      $('#btnToggleAvail').onclick=()=>{ markingAvailability=!markingAvailability; alert(markingAvailability?"Click days to toggle availability for the selected person":"Back to adding activities"); };

      function render(){
        monthLabel.textContent=state.cursor.toLocaleString(undefined,{month:'long',year:'numeric'});
        gridEl.innerHTML='';
        const first=new Date(state.cursor.getFullYear(),state.cursor.getMonth(),1);
        const start=new Date(first);
        let day=(first.getDay()+6)%7; start.setDate(first.getDate()-day);
        for(let i=0;i<42;i++){
          const d=new Date(start); d.setDate(start.getDate()+i);
          const k=toKey(d);
          const cell=document.createElement('div'); cell.className='cell';
          if(d.getMonth()!==state.cursor.getMonth()) cell.classList.add('other-month');
          if(k===toKey(state.today)) cell.classList.add('today');

          const num=document.createElement('div'); num.className='daynum'; num.textContent=String(d.getDate()); cell.appendChild(num);

          const dots=document.createElement('div'); dots.className='avail-dots';
          const byDay = state.availability[k] || {};
          Object.keys(byDay).forEach(uid=>{
            if(!byDay[uid]) return; const u = state.users.find(x=>x.id===uid); if(!u) return;
            const dot=document.createElement('div'); dot.className='dot-user'; dot.style.background=u.color; dots.appendChild(dot);
          });
          if(dots.children.length) cell.appendChild(dots);

          const todays=state.events.filter(ev=>ev.date===k).sort((a,b)=>(a.start||'00:00').localeCompare(b.start||'00:00'));
          todays.forEach(ev=>{
            const el=document.createElement('div'); el.className='event'+(ev.cancelled?' cancelled':''); el.title='Click to edit';
            const label=document.createElement('div'); label.className='label';
            const title=document.createElement('div'); title.textContent=ev.title||'(Untitled)';
            const sub=document.createElement('small'); const t1=ev.start||''; const t2=ev.end||'';
            sub.textContent=[t1&&t2?`${t1}–${t2}`:t1||t2, (ev.people&&ev.people.length?` · ${ev.people.join(', ')}`:'')].filter(Boolean).join('');
            label.appendChild(title); label.appendChild(sub);
            const actions=document.createElement('div'); actions.className='actions';
            const cancelBtn=document.createElement('button'); cancelBtn.className='mini-btn'; cancelBtn.textContent='✕'; cancelBtn.title=ev.cancelled?'Uncancel':'Cancel';
            cancelBtn.addEventListener('click',(e)=>{ e.stopPropagation(); ev.cancelled=!ev.cancelled; saveEvent(ev); });
            actions.appendChild(cancelBtn);
            el.appendChild(label); el.appendChild(actions);
            el.addEventListener('click',()=>openDialog(ev));
            cell.appendChild(el);
          });

          cell.addEventListener('click',()=>{
            if(markingAvailability){
              if(!state.currentUserId){ alert('Pick a person in the sidebar first.'); return; }
              const dayMap = state.availability[k] || (state.availability[k]={});
              dayMap[state.currentUserId] = !dayMap[state.currentUserId];
              saveLocal(); render();
            }else{
              openDialog({date:k,start:'18:00',end:'20:00'});
            }
          });

          gridEl.appendChild(cell);
        }
        roomLabel.textContent=`Room: ${state.room||'—'}`;
        renderUsersList();
        saveLocal();
        renderSidePresence();
      }

      const dlg=$('#eventDialog'); const form=$('#eventForm');
      const idEl=$('#evtId'), titleEl=$('#evtTitle'), dateEl=$('#evtDate'), sEl=$('#evtStart'), eEl=$('#evtEnd'), pEl=$('#evtPeople'), nEl=$('#evtNotes');
      const statusChip=$('#evtStatusChip');

      function openDialog(evt){ idEl.value=evt.id||''; titleEl.value=evt.title||''; dateEl.value=evt.date||toKey(new Date()); sEl.value=evt.start||'18:00'; eEl.value=evt.end||'20:00'; pEl.value=(evt.people||[]).join(', '); nEl.value=evt.notes||''; setStatusChip(!!evt.cancelled); $('#btnDelete').style.display=evt.id?'inline-flex':'none'; dlg.showModal(); }
      function setStatusChip(c){ statusChip.textContent=c?'Cancelled':'Planned'; statusChip.style.opacity=c?'.8':'1'; }
      form.addEventListener('submit',(e)=>{ const action=e.submitter&&e.submitter.value; if(action!=='save'){return;} e.preventDefault(); const id=idEl.value||genId('e'); const evt={ id, title:(titleEl.value||'').trim()||'Untitled', date:dateEl.value||toKey(new Date()), start:sEl.value||'', end:eEl.value||'', people:pEl.value? pEl.value.split(',').map(s=>s.trim()).filter(Boolean):[], notes:nEl.value||'', cancelled:(state.events.find(x=>x.id===id)||{}).cancelled||false }; saveEvent(evt); dlg.close(); });
      $('#btnDelete').onclick=async()=>{ const id=idEl.value; if(!id){ dlg.close(); return;} await deleteEventById(id); dlg.close(); };

      $('#btnPrev').onclick=()=>{ state.cursor=new Date(state.cursor.getFullYear(), state.cursor.getMonth()-1,1); render(); };
      $('#btnNext').onclick=()=>{ state.cursor=new Date(state.cursor.getFullYear(), state.cursor.getMonth()+1,1); render(); };
      $('#btnAdd').onclick=()=>openDialog({date:toKey(state.today)});
      statusChip.onclick=()=>{ const id=idEl.value; if(id){ const idx=state.events.findIndex(x=>x.id===id); if(idx>=0){ state.events[idx].cancelled=!state.events[idx].cancelled; saveEvent(state.events[idx]); } } else { setStatusChip(statusChip.textContent!=='Cancelled'); } };

      btnRooms.onclick=()=>{ roomsPopover.classList.toggle('open'); refreshRoomsList(); };
      btnPresence.onclick=()=>{ presencePopover.classList.toggle('open'); };
      if(SINGLETON.docHandler){ document.removeEventListener('click', SINGLETON.docHandler); }
      SINGLETON.docHandler=(e)=>{ if(!presencePopover.contains(e.target) && e.target!==btnPresence) presencePopover.classList.remove('open'); if(!roomsPopover.contains(e.target) && e.target!==btnRooms) roomsPopover.classList.remove('open'); };
      document.addEventListener('click', SINGLETON.docHandler);

      btnCreateRoom.onclick=()=>{ const nm=sanitizeRoomName(newRoomInput.value); if(!nm) return; if(!rooms.includes(nm)){ rooms.unshift(nm); saveRooms(); } roomInput.value=nm; joinRoom(); newRoomInput.value=''; roomsPopover.classList.remove('open'); };
      btnJoin.onclick=()=> joinRoom(); btnLeave.onclick=()=> leaveRoom();

      btnAddUser.onclick=addUserFromInput;
      newUserName.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addUserFromInput(); } });
      function addUserFromInput(){ const raw=(newUserName.value||'').trim(); if(!raw) return; if(state.users.some(u=>u.name.toLowerCase()===raw.toLowerCase())){ alert('Name already exists.'); return; } const color=PALETTE[state.users.length % PALETTE.length]; const u={ id:genId('u'), name:raw, color }; state.users.push(u); state.currentUserId=u.id; newUserName.value=''; saveLocal(); render(); }

      function renderUsersList(){
        usersList.innerHTML='';
        actingAsEl.textContent = displayNameOf(state.currentUserId) || '—';
        if(!state.users.length){ const d=document.createElement('div'); d.className='muted'; d.textContent='No people yet — add some!'; usersList.appendChild(d); return; }
        state.users.forEach(u=>{
          const row=document.createElement('div'); row.className='user-row';
          const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=u.color;
          const name=document.createElement('div'); name.innerHTML=`<strong>${escapeHtml(u.name)}</strong>`;
          const actions=document.createElement('div'); actions.className='actions';
          const actBtn=document.createElement('button'); actBtn.className='btn small'; actBtn.textContent = (u.id===state.currentUserId)?'Selected':'Select';
          actBtn.addEventListener('click',(e)=>{ e.preventDefault(); state.currentUserId=u.id; saveLocal(); renderUsersList(); });
          const delBtn=document.createElement('button'); delBtn.className='btn small'; delBtn.textContent='Delete';
          delBtn.addEventListener('click',(e)=>{ e.preventDefault(); state.users = state.users.filter(x=>x.id!==u.id); Object.keys(state.availability).forEach(k=>{ if(state.availability[k] && state.availability[k][u.id]) delete state.availability[k][u.id]; }); if(state.currentUserId===u.id) state.currentUserId = state.users[0]?.id || ''; saveLocal(); render(); });
          actions.appendChild(actBtn); actions.appendChild(delBtn);
          row.appendChild(sw); row.appendChild(name); row.appendChild(actions);
          usersList.appendChild(row);
        });
      }

      function sanitizeRoomName(s){ return (s||'').toLowerCase().trim().replace(/[^a-z0-9-_]+/g,'-').replace(/^-+|-+$/g,'').slice(0,64); }
      function displayNameOf(uid){ return (state.users.find(u=>u.id===uid)||{}).name || ''; }

      function saveLocal(){ const key=storageKeyFor(state.room||'local'); const data={cursor:state.cursor, events:state.events, users:state.users, currentUserId:state.currentUserId, availability:state.availability}; localStorage.setItem(key, JSON.stringify(data)); if(state.userName) localStorage.setItem('displayName', state.userName); if(state.room && !rooms.includes(state.room)){ rooms.unshift(state.room); saveRooms(); } localStorage.setItem('last-room', state.room||''); }
      function loadLocal(room){ const key=storageKeyFor(room||'local'); try{ const raw=localStorage.getItem(key); if(!raw) throw 0; const s=JSON.parse(raw); state.cursor=s.cursor?new Date(s.cursor):new Date(new Date().getFullYear(), new Date().getMonth(),1); state.events=Array.isArray(s.events)?s.events:[]; state.users=Array.isArray(s.users)?s.users:[]; state.currentUserId=s.currentUserId||state.users[0]?.id||''; state.availability=s.availability||{}; }catch{ state.cursor=new Date(new Date().getFullYear(), new Date().getMonth(),1); state.events=[]; state.users=[]; state.currentUserId=''; state.availability={}; }
      }
      function loadRooms(){ try{ const list=JSON.parse(localStorage.getItem(ROOMS_KEY)||'[]'); return Array.isArray(list)? list : []; }catch{ return []; } }
      function saveRooms(){ localStorage.setItem(ROOMS_KEY, JSON.stringify(rooms.slice(0,50))); }
      function refreshRoomsList(){ roomsList.innerHTML=''; if(!rooms.length){ const p=document.createElement('div'); p.className='muted'; p.textContent='No rooms yet. Create one below.'; roomsList.appendChild(p); return; } rooms.forEach(nm=>{ const row=document.createElement('div'); row.className='room-item'; const nameSpan=document.createElement('span'); nameSpan.className='room-name'; nameSpan.textContent=nm; const act=document.createElement('div'); act.className='rooms-actions'; const joinBtn=document.createElement('button'); joinBtn.className='btn small'; joinBtn.textContent= nm===state.room? 'Open':'Join'; const delBtn=document.createElement('button'); delBtn.className='btn small'; delBtn.textContent='Delete'; function go(){ roomInput.value=nm; roomsPopover.classList.remove('open'); joinRoom(); } row.addEventListener('click', go); joinBtn.addEventListener('click',(e)=>{ e.stopPropagation(); go(); }); delBtn.addEventListener('click',(e)=>{ e.stopPropagation(); rooms=rooms.filter(r=>r!==nm); saveRooms(); refreshRoomsList(); }); act.appendChild(joinBtn); act.appendChild(delBtn); row.appendChild(nameSpan); row.appendChild(act); roomsList.appendChild(row); }); }

      let app=null, db=null, unsubEvents=null, unsubPresence=null, presenceDocRef=null; let fbReady=false;
      async function initFirebase(){ if(!FIREBASE_CONFIG){ fbReady=false; return; } const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'); const { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, serverTimestamp, query, orderBy } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'); app=initializeApp(FIREBASE_CONFIG); db=getFirestore(app); fbReady=true; window.__fb={ collection, doc, onSnapshot, setDoc, deleteDoc, serverTimestamp, query, orderBy }; liveBadge.textContent='Live ready (paste config ✓)'; }

      function renderSidePresence(){
        sidePresence.innerHTML='';
        const list = state.online;
        presenceCountEl.textContent = String(list.length);
        sideCount.textContent = String(list.length);
        sideHint.textContent = fbReady? '' : 'Presence is local-only until you paste Firebase config.';
        if(!list.length){ const d=document.createElement('div'); d.className='muted'; d.textContent='No one here yet.'; sidePresence.appendChild(d); return; }
        list.forEach(u=>{
          const row=document.createElement('div'); row.className='user-row';
          const av=document.createElement('div'); av.className='swatch'; av.style.background = hashColor(u.id);
          const name=document.createElement('div'); name.innerHTML=`<strong>${escapeHtml(u.name||'Guest')}</strong><div class="tiny">${u.id===CLIENT_ID?'You':''}</div>`;
          row.appendChild(av); row.appendChild(name); sidePresence.appendChild(row);
        });
      }

      function hashColor(id){ let h=0; for(let i=0;i<id.length;i++){ h=(h*31+id.charCodeAt(i))|0; } const colors=PALETTE; return colors[Math.abs(h)%colors.length]; }

      async function joinRoom(){
        state.userName=(nameInput.value||'').trim()||'Guest';
        const nextRoom=sanitizeRoomName(roomInput.value)||'default';
        if(state.room===nextRoom && fbReady) return;
        await leaveRoom(false);
        state.room=nextRoom; loadLocal(state.room); roomLabel.textContent=`Room: ${state.room}`; if(!rooms.includes(state.room)){ rooms.unshift(state.room); saveRooms(); }
        if(!fbReady){ liveBadge.textContent=`Local room: ${state.room} (no sync)`; render(); return; }
        const { collection, doc, onSnapshot, setDoc, deleteDoc, serverTimestamp, query, orderBy } = window.__fb;
        const eventsCol=collection(db,'rooms',state.room,'events');
        unsubEvents = onSnapshot(query(eventsCol, orderBy('date'), orderBy('start')),(snap)=>{ state.events=snap.docs.map(d=>({ id:d.id, ...d.data() })); render(); });
        const presenceCol=collection(db,'rooms',state.room,'presence');
        presenceDocRef = doc(presenceCol, CLIENT_ID);
        await setDoc(presenceDocRef, { id:CLIENT_ID, name:state.userName, lastActive: serverTimestamp() }, { merge:true });
        if(presenceInterval) clearInterval(presenceInterval);
        presenceInterval = setInterval(()=>{ setDoc(presenceDocRef, { name: state.userName, lastActive: serverTimestamp() }, { merge:true }); }, 15000);
        unsubPresence = onSnapshot(presenceCol,(snap)=>{ state.online = snap.docs.map(d=>d.data()).sort((a,b)=> (a.name||'').localeCompare(b.name||'')); renderSidePresence(); });
        render();
        window.addEventListener('beforeunload', cleanupPresence, { once:true });
      }

      async function leaveRoom(resetInputs=true){ if(unsubEvents){unsubEvents();unsubEvents=null;} if(unsubPresence){unsubPresence();unsubPresence=null;} if(presenceInterval){clearInterval(presenceInterval);presenceInterval=null;} await cleanupPresence(); if(resetInputs){ roomInput.value=''; } presenceCountEl.textContent='0'; sideCount.textContent='0'; rosterEl.innerHTML=''; sidePresence.innerHTML=''; liveBadge.textContent = FIREBASE_CONFIG? 'Live ready' : 'Local only'; }
      async function cleanupPresence(){ try{ if(presenceDocRef && fbReady){ const { deleteDoc } = window.__fb; await deleteDoc(presenceDocRef); } }catch{} finally{ presenceDocRef=null; } }

      async function saveEvent(evt){ const idx=state.events.findIndex(x=>x.id===evt.id); if(idx>=0) state.events[idx]=evt; else state.events.push(evt); if(fbReady && state.room){ const { collection, doc, setDoc } = window.__fb; const ref=doc(collection(db,'rooms',state.room,'events'), evt.id); await setDoc(ref, evt, { merge:true }); } saveLocal(); render(); }
      async function deleteEventById(id){ state.events=state.events.filter(x=>x.id!==id); if(fbReady && state.room){ const { collection, doc, deleteDoc } = window.__fb; const ref=doc(collection(db,'rooms',state.room,'events'), id); try{ await deleteDoc(ref);}catch{} } saveLocal(); render(); }

      function escapeHtml(s){ const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}; return String(s||'').replace(/[&<>"']/g, ch=>map[ch]); }

      (function runSelfTests(){ const assert=(c,m)=>{ if(!c) console.error('TEST FAIL:',m); }; assert(escapeHtml('<>&"\'')==='&lt;&gt;&amp;&quot;&#39;','escapeHtml converts core chars'); const tmp={ users:[], availability:{}, currentUserId:'' }; const u1={id:'u1',name:'A',color:'#000'}; tmp.users.push(u1); tmp.currentUserId='u1'; const k='2025-09-30'; (tmp.availability[k]||(tmp.availability[k]={}))[tmp.currentUserId]=true; assert(tmp.availability[k].u1===true,'availability toggles per user/day'); })();

      (async function init(){ try{ await initFirebase(); }catch{} liveBadge.textContent = FIREBASE_CONFIG? 'Live ready' : 'Local only'; const last = localStorage.getItem('last-room') || rooms[0] || 'general'; roomInput.value=last; joinRoom(); render(); })();

      SINGLETON.teardown=()=>{ try{ if(SINGLETON.docHandler) document.removeEventListener('click', SINGLETON.docHandler); }catch{} try{ if(presenceInterval) clearInterval(presenceInterval); }catch{} };
    })();
  </script>
</body>
</html>
